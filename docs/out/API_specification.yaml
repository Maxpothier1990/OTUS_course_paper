openapi: 3.0.0
info:
  title: КиберФуд
  description: OpenAPI спецификация для табло самообслуживания
  version: '0.1.2'
servers:
  - url: https://localhost:8080/api/v1/

paths:
  /auth/login:
    post:
      tags:
        - Аутентификация
      summary: Вход в систему
      description: Авторизация пользователя по номеру телефона и получение JWT токена
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        "200":
          description: Успешная авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        "400":
          description: Неверный запрос
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "401":
          description: Неверные учетные данные
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /auth/register:
    post:
      tags:
        - Аутентификация
      summary: Регистрация нового пользователя
      description: Создание новой учетной записи по номеру телефона
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        "201":
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        "400":
          description: Неверный запрос или пользователь уже существует
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /auth/verify:
    post:
      tags:
        - Аутентификация
      summary: Подтверждение номера телефона
      description: Подтверждение номера телефона через SMS код
      operationId: verifyPhone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
      responses:
        "200":
          description: Номер телефона подтвержден
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Номер телефона успешно подтвержден"
        "400":
          description: Неверный код подтверждения
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /dishes:
    get:
      tags:
        - Меню
      summary: Получение списка блюд
      description: Получает список блюд доступных для заказа с постраничной навигацией. Возвращает только основную информацию для превью.
      operationId: getDishes
      parameters:
        - name: offset
          in: query
          description: Номер первого элемента на странице
          required: false
          style: form
          explode: true
          schema:
            minimum: 0
            type: integer
            default: 0
        - name: limit
          in: query
          description: Количество элементов на странице
          required: false
          style: form
          explode: true
          schema:
            maximum: 10
            minimum: 1
            type: integer
            default: 10
        - name: sortDirection
          in: query
          description: Направление сортировки
          schema:
            enum:
              - asc
              - desc
      responses:
        "200":
          description: Получен список блюд
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DishShort'
        "400":
          description: Неверный запрос
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /dishes/{dishId}:
    get:
      tags:
        - Меню
      summary: Получение детальной информации о блюде
      description: Получает полную информацию о конкретном блюде по его ID
      operationId: getDishById
      parameters:
        - name: dishId
          in: path
          required: true
          description: Идентификатор блюда
          schema:
            type: integer
      responses:
        "200":
          description: Получена детальная информация о блюде
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DishFull'
        "400":
          description: Неверный запрос
        "404":
          description: Блюдо не найдено
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /dishes/{dishId}/reviews:
    get:
      tags:
        - Отзывы
      summary: Просмотр отзывов о блюде
      description: Получает все отзывы о блюде по его ID
      operationId: getDishesReviews
      parameters:
        - name: dishId
          in: path
          description: Идентификатор блюда
          required: true
          schema:
            type: integer
        - name: offset
          in: query
          description: Номер первого элемента на странице
          required: false
          style: form
          explode: true
          schema:
            minimum: 0
            type: integer
            default: 0
        - name: limit
          in: query
          description: Количество элементов на странице
          required: false
          style: form
          explode: true
          schema:
            maximum: 20
            minimum: 1
            type: integer
            default: 10
        - name: sortDirection
          in: query
          description: Направление сортировки по дате создания (по умолчанию от новых к старым)
          schema:
            enum:
              - asc
              - desc
            default: desc
        - name: minRating
          in: query
          description: Минимальный рейтинг для фильтрации
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 5
      responses:
        "200":
          description: Получены отзывы о блюде
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedReviewsResponse'
        "404":
          description: Блюдо не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
  /orders:
    post:
      tags:
        - Заказы
      summary: Создание нового заказа
      description: Создает новый заказ. Для повторного заказа передайте previousOrderId в теле запроса.
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        "201":
          description: Заказ успешно создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        "400":
          description: Неверный запрос (например, невалидные данные или блюдо недоступно)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "401":
          description: Пользователь не авторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /orders/{orderId}:
    get:
      tags:
        - Заказы
      summary: Получить статус заказа
      description: Быстро получает статус заказа с минимальным трафиком
      operationId: getOrderStatus
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          description: Идентификатор заказа
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Статус заказа получен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderStatus'
        "401":
          description: Пользователь не авторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "403":
          description: Заказ не принадлежит пользователю
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "404":
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /orders/{orderId}/details:
    get:
      tags:
        - Заказы
      summary: Получить детали заказа для повторного заказа
      description: Получает полную информацию о заказе, включая список блюд и их количество. Используется для предзаполнения формы при создании повторного заказа.
      operationId: getOrderDetailsForReorder
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          description: Идентификатор заказа, который нужно повторить
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Детали заказа получены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderForReorder'
        "401":
          description: Пользователь не авторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "403":
          description: Заказ не принадлежит пользователю
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "404":
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /orders/{orderId}/dishes/{dishId}/review:
    post:
      tags:
        - Отзывы
      summary: Добавление отзыва о блюде в заказе
      description: Добавляет отзыв о конкретном блюде в конкретном заказе
      operationId: postOrderDishReview
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          description: Идентификатор заказа
          required: true
          schema:
            type: integer
        - name: dishId
          in: path
          description: Идентификатор блюда
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReviewRequest'
      responses:
        "200":
          description: Отзыв добавлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        "400":
          description: Неверный запрос (например, блюдо не входит в заказ)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "403":
          description: Запрещено (например, заказ не принадлежит пользователю)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "409":
          description: Отзыв уже существует для этого блюда в заказе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /orders/{orderId}/reviews:
    get:
      tags:
        - Отзывы
      summary: Просмотр всех отзывов по заказу
      description: Получает все отзывы о блюдах в конкретном заказе
      operationId: getOrderReviews
      parameters:
        - name: orderId
          in: path
          description: Идентификатор заказа
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Review'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

  /orders/history:
    get:
      tags:
        - История заказов
      summary: Получить историю заказов пользователя
      description: Получает историю заказов текущего пользователя с постраничной навигацией
      operationId: getOrderHistory
      security:
        - bearerAuth: []
      parameters:
        - name: offset
          in: query
          description: Номер первого элемента на странице
          required: false
          style: form
          explode: true
          schema:
            minimum: 0
            type: integer
            default: 0
        - name: limit
          in: query
          description: Количество элементов на странице
          required: false
          style: form
          explode: true
          schema:
            maximum: 20
            minimum: 1
            type: integer
            default: 10
        - name: sortDirection
          in: query
          description: Направление сортировки по дате создания (по умолчанию от новых к старым)
          schema:
            enum:
              - asc
              - desc
            default: desc
        - name: status
          in: query
          description: Фильтр по статусу заказа
          required: false
          schema:
            type: string
            enum: ['pending', 'confirmed', 'preparing', 'ready_for_pickup', 'completed', 'cancelled']
        - name: dateFrom
          in: query
          description: Фильтр по дате начала (включительно)
          required: false
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          description: Фильтр по дате окончания (включительно)
          required: false
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Получена история заказов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderHistoryResponse'
        "401":
          description: Пользователь не авторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'
        "500":
          description: Сервер не отвечает
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedErrorMessage'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен авторизации

  schemas:
    LoginRequest:
      type: object
      required:
        - phone
        - password
      properties:
        phone:
          type: string
          pattern: '^\+7\d{10}$'
          example: "+79991234567"
          description: Номер телефона в формате +7XXXXXXXXXX (11 цифр)
        password:
          type: string
          format: password
          minLength: 6
          maxLength: 100
          description: Пароль пользователя

    LoginResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: JWT токен для доступа к защищенным эндпоинтам
        refreshToken:
          type: string
          description: Токен для обновления access token
        expiresIn:
          type: integer
          description: Время жизни access token в секундах
        tokenType:
          type: string
          description: Тип токена (обычно "Bearer")
          default: "Bearer"
        userId:
          type: string
          description: Идентификатор пользователя
        phone:
          type: string
          description: Номер телефона пользователя

    RegisterRequest:
      type: object
      required:
        - phone
        - password
      properties:
        phone:
          type: string
          pattern: '^\+7\d{10}$'
          example: "+79991234567"
          description: Номер телефона в формате +7XXXXXXXXXX (11 цифр)
        password:
          type: string
          format: password
          minLength: 6
          maxLength: 100
          description: Пароль пользователя (минимум 6 символов)

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          description: Сообщение о результате регистрации
          example: "На ваш номер телефона отправлен код подтверждения"
        userId:
          type: string
          description: Временный идентификатор пользователя (до подтверждения)
        phone:
          type: string
          description: Номер телефона пользователя

    VerifyRequest:
      type: object
      required:
        - userId
        - verificationCode
      properties:
        userId:
          type: string
          description: Временный идентификатор пользователя
        verificationCode:
          type: string
          pattern: '^\d{4,6}$'
          description: Код подтверждения из SMS
          example: "123456"

    DishShort:
      type: object
      required:
        - dishId
        - name
        - price
        - status
      properties:
        dishId:
          type: integer
          example: 1234
        name:
          maxLength: 150
          minLength: 2
          type: string
          example: "Бургер классический"
        image:
          maxLength: 500
          type: string
          description: URL изображения для превью
        price:
          type: number
          format: float
          minimum: 0
          example: 299.99
        status:
          type: boolean
          description: Наличие блюда

    DishFull:
      allOf:
        - $ref: '#/components/schemas/DishShort'
        - type: object
          required:
            - description
            - ingredients
          properties:
            description:
              maxLength: 2000
              minLength: 50
              type: string
              description: Подробное описание блюда
            ingredients:
              type: array
              items:
                type: string
              description: Список ингредиентов
            weight:
              type: integer
              description: Вес в граммах
            calories:
              type: integer
              description: Калорийность
            allergens:
              type: array
              items:
                type: string
              description: Список аллергенов
            rating:
              type: number
              format: float
              minimum: 0
              maximum: 5
              description: Средний рейтинг
            spiceLevel:
              type: integer
              minimum: 1
              maximum: 3
              description: Уровень остроты (1-3)
            dietaryInfo:
              type: array
              items:
                type: string
                enum: [vegetarian, vegan, glutenFree, lactoseFree]
              description: Диетическая информация

    CreateOrderRequest:
      type: object
      required:
        - items
        - paymentMethod
      properties:
        items:
          type: array
          description: Список позиций в заказе
          minItems: 1
          items:
            $ref: '#/components/schemas/OrderItemRequest'
        paymentMethod:
          type: string
          enum: ['card', 'cash', 'qr_code']
          description: Способ оплаты
        previousOrderId:
          type: integer
          description: Идентификатор предыдущего заказа, если это повторный заказ. Используется для аналитики и отслеживания повторных покупок.
        comment:
          type: string
          description: Комментарий к заказу
          maxLength: 500
        deliveryAddress:
          type: string
          description: Адрес доставки (если требуется)
          maxLength: 500

    OrderItemRequest:
      type: object
      required:
        - dishId
        - quantity
      properties:
        dishId:
          type: integer
          description: Идентификатор блюда
        quantity:
          type: integer
          description: Количество данного блюда в заказе
          minimum: 1
          maximum: 20
        specialInstructions:
          type: string
          description: Особые пожелания к приготовлению
          maxLength: 500

    OrderStatus:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: ['pending', 'confirmed', 'preparing', 'ready_for_pickup', 'completed', 'cancelled']
          description: Текущий статус заказа
    OrderResponse:
      type: object
      required:
        - orderId
        - orderNumber
        - status
        - createdAt
        - totalAmount
        - items
      properties:
        orderId:
          type: integer
          description: Внутренний идентификатор заказа в системе
        orderNumber:
          type: string
          description: Публичный номер заказа для клиента (генерируется на сервере)
          example: "ORD-2023-12345"
        status:
          type: string
          enum: ['pending', 'confirmed', 'preparing', 'ready_for_pickup', 'completed', 'cancelled']
          description: Текущий статус заказа
        previousOrderId:
          type: integer
          description: Идентификатор предыдущего заказа для повторных заказов
        createdAt:
          type: string
          format: date-time
          description: Дата и время создания заказа
        estimatedReadyTime:
          type: string
          format: date-time
          description: Расчетное время готовности
        totalAmount:
          type: number
          format: float
          description: Общая сумма заказа
          minimum: 0
        items:
          type: array
          description: Позиции заказа с актуальными ценами
          items:
            $ref: '#/components/schemas/OrderItemResponse'
        paymentMethod:
          type: string
          enum: ['card', 'cash', 'qr_code']
          description: Способ оплаты
        paymentStatus:
          type: string
          enum: ['pending', 'paid', 'failed', 'refunded']
          description: Статус оплаты
        pickupCode:
          type: string
          description: Код для получения заказа (если требуется)
        qrCodeUrl:
          type: string
          description: URL QR-кода для отслеживания заказа
        comment:
          type: string
          description: Комментарий к заказу
        deliveryAddress:
          type: string
          description: Адрес доставки

    OrderItemResponse:
      type: object
      required:
        - dishId
        - name
        - quantity
        - unitPrice
        - totalPrice
      properties:
        dishId:
          type: integer
          description: Идентификатор блюда
        name:
          type: string
          description: Название блюда
        quantity:
          type: integer
          description: Количество
        unitPrice:
          type: number
          format: float
          description: Цена за единицу на момент заказа
        totalPrice:
          type: number
          format: float
          description: Общая стоимость позиции (unitPrice × quantity)
        specialInstructions:
          type: string
          description: Особые пожелания

    OrderForReorder:
      type: object
      required:
        - orderId
        - orderNumber
        - createdAt
        - items
        - totalAmount
      properties:
        orderId:
          type: integer
          description: Идентификатор заказа
        orderNumber:
          type: string
          description: Номер заказа
          example: "ORD-2023-12345"
        createdAt:
          type: string
          format: date-time
          description: Дата и время создания оригинального заказа
        items:
          type: array
          description: Список позиций из оригинального заказа
          items:
            $ref: '#/components/schemas/OrderItemForReorder'
        totalAmount:
          type: number
          format: float
          description: Общая сумма оригинального заказа

    OrderItemForReorder:
      type: object
      required:
        - dishId
        - name
        - quantity
        - price
        - isAvailable
      properties:
        dishId:
          type: integer
          description: Идентификатор блюда
        name:
          type: string
          description: Название блюда
        quantity:
          type: integer
          description: Количество в оригинальном заказе
        price:
          type: number
          format: float
          description: Цена за единицу в оригинальном заказе
        specialInstructions:
          type: string
          description: Особые пожелания из оригинального заказа
        isAvailable:
          type: boolean
          description: Доступно ли блюдо в текущем меню

    OrderHistoryItem:
      type: object
      required:
        - orderId
        - orderNumber
        - status
        - createdAt
        - totalAmount
        - itemsCount
      properties:
        orderId:
          type: integer
          description: Идентификатор заказа
        orderNumber:
          type: string
          description: Номер заказа
          example: "ORD-2023-12345"
        status:
          type: string
          enum: ['pending', 'confirmed', 'preparing', 'ready_for_pickup', 'completed', 'cancelled']
          description: Текущий статус заказа
        createdAt:
          type: string
          format: date-time
          description: Дата и время создания заказа
        totalAmount:
          type: number
          format: float
          description: Общая сумма заказа
        itemsCount:
          type: integer
          description: Общее количество позиций в заказе
        estimatedReadyTime:
          type: string
          format: date-time
          description: Расчетное время готовности
        paymentStatus:
          type: string
          enum: ['pending', 'paid', 'failed', 'refunded']
          description: Статус оплаты
        hasReview:
          type: boolean
          description: Есть ли у заказа оставленные отзывы
        deliveryAddress:
          type: string
          description: Адрес доставки (если была доставка)

    OrderHistoryResponse:
      type: object
      required:
        - total
        - offset
        - limit
        - orders
      properties:
        total:
          type: integer
          description: Общее количество заказов
        offset:
          type: integer
          description: Текущее смещение
        limit:
          type: integer
          description: Лимит на странице
        orders:
          type: array
          description: Список заказов
          items:
            $ref: '#/components/schemas/OrderHistoryItem'

    CreateReviewRequest:
      type: object
      required:
        - text
        - rating
      properties:
        text:
          type: string
          minLength: 10
          maxLength: 1000
          description: Текст отзыва
        rating:
          type: integer
          description: Рейтинг, выставленный блюду
          minimum: 1
          maximum: 5

    Review:
      type: object
      required:
        - reviewId
        - dishId
        - orderId
        - userId
        - text
        - rating
        - createdAt
      properties:
        reviewId:
          type: integer
          description: Уникальный идентификатор отзыва
        dishId:
          type: integer
          description: Идентификатор блюда
        orderId:
          type: integer
          description: Идентификатор заказа, в котором было это блюдо
        userId:
          type: string
          description: Идентификатор пользователя, оставившего отзыв
        text:
          type: string
          description: Текст отзыва
        rating:
          type: integer
          description: Рейтинг, выставленный блюду
          minimum: 1
          maximum: 5
        createdAt:
          type: string
          format: date-time
          description: Дата и время создания отзыва
        updatedAt:
          type: string
          format: date-time
          description: Дата и время последнего обновления отзыва
    PaginatedReviewsResponse:
      type: object
      required:
        - total
        - offset
        - limit
        - reviews
      properties:
        total:
          type: integer
          description: Общее количество отзывов
          example: 125
        offset:
          type: integer
          description: Текущее смещение
          example: 0
        limit:
          type: integer
          description: Лимит на странице
          example: 10
        averageRating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          description: Средний рейтинг блюда
          example: 4.5
        reviews:
          type: array
          description: Список отзывов на текущей странице
          items:
            $ref: '#/components/schemas/Review'
    ExtendedErrorMessage:
      description: Сообщение об ошибке
      allOf:
        - type: object
          required:
            - techInfo
            - traceID
          properties:
            techInfo:
              type: string
            traceID:
              type: string